<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requests</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="index.css">
    <style>
   form {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Ensures padding and border are included in the element's total width and height */
        }

        textarea {
            height: 100px; /* Adjust as needed */
            resize: vertical; /* Allows the user to adjust the height */
        }

        button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #449d44;
        }

        /* Styling for the image upload */
        input[type="file"] {
            margin-bottom: 10px;
        }
        .post {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .post-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        .post-image {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
        }

        .post-description {
            margin-bottom: 10px;
        }

        .post-poster {
            font-style: italic;
            text-align: right;
        }

        .post-poster a {
            color: #007bff;
            text-decoration: none;
        }

        .post-poster a:hover {
            text-decoration: underline;
        }

        .delete-button {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-end;
        }

        .delete-button:hover {
            background-color: #cc0000;
        }
    </style>
</head>
<body class="requests">
    <h1 class="page-title">Request Forum</h1>
    <p class="page-subtitle">Welcome to your requests page.</p>
    <form id="postForm">
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required>

        <label for="image">Image:</label>
        <input type="file" id="image" name="image" accept="image/*">

        <label for="description">Description:</label>
        <textarea id="description" name="description" required></textarea>

        <button type="button" onclick="createPost()">Create Post</button>
    </form>

    <!-- Container to display posts -->
    <div id="postsContainer"></div>

    <script>
        // Firebase configuration (Ensure this matches your main config)
        const firebaseConfig = {
            apiKey: "AIzaSyAhcjMfi1p5YGyRiK14ux7gdYcEAYBXtGc",
            authDomain: "request-form-263db.firebaseapp.com",
            projectId: "request-form-263db",
            messagingSenderId: "729877304681",
            appId: "1:729877304681:web:3983c69cee3afd18ae59f8"
        };

        // Initialize Firebase (if not already initialized)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                console.log("User is signed in:", user);
                loadPosts(user.uid); // Pass the user's ID to loadPosts
            } else {
                // No user is signed in.
                console.log("No user is signed in.");
                window.location.href = "index.html"; // Redirect to sign-in page
            }
        });

        function loadPosts(currentUserId) {
    const postsContainer = document.getElementById("postsContainer");
    postsContainer.innerHTML = ""; // Clear existing posts

    db.collection("posts").orderBy("timestamp", "desc").get()
        .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const post = doc.data();
                const postId = doc.id; // Get the document ID

                // Create post elements
                const postDiv = document.createElement("div");
                postDiv.classList.add("post");

                // Add the image if it exists
                if (post.imageUrl) {
                    const imageElement = document.createElement("img");
                    imageElement.classList.add("post-image");
                    imageElement.src = post.imageUrl; // Use the image URL
                    imageElement.alt = "Post Image"; // Add alt text for accessibility
                    postDiv.appendChild(imageElement);
                }

                const titleElement = document.createElement("h2");
                titleElement.classList.add("post-title");
                titleElement.textContent = post.title;
                postDiv.appendChild(titleElement);

                const descriptionElement = document.createElement("p");
                descriptionElement.classList.add("post-description");
                descriptionElement.textContent = post.description;
                postDiv.appendChild(descriptionElement);

                const posterElement = document.createElement("p");
                posterElement.classList.add("post-poster");
                posterElement.innerHTML = `Posted by: <a href="profileTemplate.html?userId=${post.posterId}">${post.posterName}</a>`;
                postDiv.appendChild(posterElement);

                // Add delete button if the current user is the creator of the post
                if (post.posterId === currentUserId) {
                    const deleteButton = document.createElement("button");
                    deleteButton.classList.add("delete-button");
                    deleteButton.textContent = "Delete Post";
                    deleteButton.onclick = () => deletePost(postId);
                    postDiv.appendChild(deleteButton);
                }

                postsContainer.appendChild(postDiv);
            });
        })
        .catch((error) => {
            console.error("Error getting posts: ", error);
        });
}
function createPost() {
    const title = document.getElementById("title").value;
    const description = document.getElementById("description").value;
    const imageFile = document.getElementById("image").files[0]; // Get the image file

    const user = auth.currentUser;

    if (!user) {
        console.log("No user logged in.");
        return;
    }

    if (!title || !description) {
        alert("Please fill in all fields.");
        return;
    }

    // File size limit (e.g., 1 MB = 1,048,576 bytes)
    const fileSizeLimit = 1 * 1024 * 1024; // 1 MB

    if (imageFile && imageFile.size > fileSizeLimit) {
        alert("File size exceeds the 1 MB limit. Please upload a smaller file.");
        return;
    }

    if (imageFile) {
        // Upload the image to Imgur
        uploadImageToImgur(imageFile)
            .then((imageUrl) => {
                // Save the post data to Firestore with the image URL
                savePost(title, description, imageUrl, user);
            })
            .catch((error) => {
                console.error("Error uploading image to Imgur:", error);
                alert("Failed to upload image. Please try again.");
            });
    } else {
        // If no image is selected, save the post without an image URL
        savePost(title, description, "", user);
    }
}
function deletePost(postId) {
    if (confirm("Are you sure you want to delete this post?")) {
        db.collection("posts").doc(postId).delete()
            .then(() => {
                console.log("Post successfully deleted!");
                // Reload the posts after deletion
                auth.onAuthStateChanged(user => {
                    if (user) {
                        loadPosts(user.uid); // Reload posts for the current user
                    }
                });
            })
            .catch((error) => {
                console.error("Error deleting post: ", error);
                alert("An error occurred while trying to delete the post. Please try again.");
            });
    }
}
async function uploadImageToImgur(imageFile) {
    const formData = new FormData();
    formData.append("image", imageFile);

    const response = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
            Authorization: "Client-ID 21715d0fd0bed38", // Replace with your Imgur Client ID
        },
        body: formData,
    });

    if (!response.ok) {
        throw new Error("Failed to upload image to Imgur");
    }

    const data = await response.json();
    return data.data.link; // Return the image URL
}
    </script>
</body>
</html>